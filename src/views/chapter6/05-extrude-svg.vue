<template>
  <div class="viewCon">
    <div class="canvasCon" ref="canvasCon">
      <canvas class="canvas" ref="canvasDom" />
    </div>
  </div>
</template>

<script lang="ts" setup>
/**
 * 我感觉动态的修改mesh的geometry很麻烦
 * 还是原来remove掉，重新创建geo，mesh比较方便
 */
import { ref, onMounted } from 'vue'
import { GUI } from 'dat.gui'
import * as THREE from 'three'
import Stats from 'three/examples/jsm/libs/stats.module.js'
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js'
import { transformSVGPathExposed } from '@/utils'
import { createMultiMaterialObject } from 'three/examples/jsm/utils/SceneUtils'
import { create } from 'domain'
const { random, PI, floor, ceil, min, max, sin, cos } = Math

const canvasDom = ref<HTMLElement>()
const canvasCon = ref<HTMLElement>()
let width = window.innerWidth
let height = window.innerHeight
let stats: Stats
let orbitControls: OrbitControls
let scene: THREE.Scene
let camera: THREE.PerspectiveCamera
let renderer: THREE.WebGLRenderer
let shapes: THREE.Shape[] // 通过d3-3d将svgpath转换成THREE.shape
let mesh: THREE.Mesh

const path: {
  [k: string]: string
} = {
  shape0: `M 261.135 114.535 C 254.906 116.662 247.491 118.825 244.659 119.344 C 229.433 122.131 177.907 142.565 151.973 156.101 C 111.417 177.269 78.9808 203.399 49.2992 238.815 C 41.0479 248.66 26.5057 277.248 21.0148 294.418 C 14.873 313.624 15.3588 357.341 21.9304 376.806 C 29.244 398.469 39.6107 416.935 52.0865 430.524 C 58.2431 437.23 63.3085 443.321 63.3431 444.06 C 63.4748 446.883 102.278 479.707 120.51 492.418 C 131.003 499.734 148.168 509.93 158.654 515.075 C 169.139 520.22 179.431 525.34 181.524 526.454 C 187.725 529.754 187.304 527.547 179.472 515.713 C 164.806 493.553 158.448 464.659 164.322 446.861 C 169.457 431.303 192.013 421.501 214.324 425.132 C 234.042 428.341 252.142 439.186 270.958 459.064 C 286.677 475.67 292.133 482.967 295.31 491.634 C 297.466 497.514 298.948 495.91 304.862 481.293 C 313.673 459.519 329.808 445.735 346.35 445.851 C 367.654 446 399.679 478.239 412.801 512.745 C 414.093 516.144 416.593 522.632 418.355 527.163 C 420.118 531.695 423.604 542.319 426.103 550.773 C 430.848 566.832 432.355 566.851 434.872 550.88 C 436.395 541.215 451.403 502.522 455.655 497.298 C 457.038 495.599 460.63 489.896 463.636 484.625 C 471.696 470.498 492.318 452.688 505.387 448.568 C 514.602 445.663 517.533 445.549 525.51 447.782 C 539.676 451.749 553.43 467.773 560.706 488.788 L 563.242 496.114 L 567.096 490.012 C 577.709 473.208 593.665 453.899 602.47 447.206 C 607.884 443.09 613.378 438.825 614.679 437.729 C 615.98 436.632 622.927 433.259 630.118 430.233 C 655.159 419.693 681.195 423.407 693.273 439.241 C 697.957 445.382 698.932 448.971 699.538 462.294 C 700.174 476.284 699.51 479.864 693.686 493.854 C 690.073 502.533 684.912 512.883 682.217 516.854 C 679.523 520.825 678.172 524.074 679.215 524.074 C 681.932 524.074 718.787 504.481 732.525 495.734 C 760.018 478.228 788.909 452.599 803.9 432.418 C 807.266 427.886 810.569 423.715 811.239 423.149 C 814.498 420.395 828.253 393.099 833.17 379.627 C 838.223 365.782 838.713 361.822 838.741 334.582 C 838.776 300.425 836.431 291.124 820.154 260.873 C 810.649 243.207 807.498 239.005 788.417 218.543 C 751.511 178.968 688.147 142.549 621.582 122.654 C 581.7 110.734 580.388 110.465 580.388 114.195 C 580.388 115.328 581.302 116.255 582.418 116.255 C 584.279 116.255 587.705 122.106 603.399 152.085 C 613.977 172.29 618.077 189.427 618.264 214.21 C 618.42 234.928 617.88 238.368 612.285 252.269 C 604.327 272.04 590.066 286.889 572.829 293.352 C 558.526 298.714 549.193 297.86 535.704 289.955 C 526.777 284.723 512.304 267.644 509.816 259.404 C 509.132 257.138 507.129 251.358 505.366 246.558 C 503.602 241.759 501.646 231.564 501.018 223.902 C 500.39 216.24 498.491 198.402 496.797 184.261 C 495.104 170.121 493.307 152.047 492.803 144.097 C 492.299 136.147 491.292 125.625 490.565 120.715 L 489.242 111.787 L 483.323 118.267 C 480.067 121.832 477.404 125.618 477.404 126.681 C 477.404 127.744 476.603 128.613 475.624 128.613 C 474.645 128.613 471.275 132.321 468.135 136.852 L 462.426 145.091 L 431.038 145.091 L 399.65 145.091 L 386.811 128.494 C 379.749 119.365 373.509 112.36 372.943 112.926 C 372.377 113.491 371.57 118.875 371.15 124.888 C 370.73 130.902 368.94 147.744 367.172 162.315 C 365.405 176.887 363.523 195.424 362.99 203.509 C 360.283 244.622 352.784 266.044 335.323 282.544 C 326.456 290.923 312.488 297.497 303.508 297.518 C 294.864 297.539 278.732 290.063 269.473 281.748 C 246.952 261.521 238.846 229.614 245.481 187.314 C 247.894 171.928 266.562 131.612 275.927 121.56 C 277.987 119.348 279.673 116.786 279.673 115.867 C 279.673 114.947 279.905 113.593 280.188 112.856 C 281.28 110.017 271.977 110.837 261.136 114.536 L 261.135 114.535 `,
  shape1: `M162.133333 776.533333c-17.066667 0-34.133333 12.8-34.133333 34.133334 0 17.066667 17.066667 29.866667 34.133333 34.133333 85.333333 4.266667 170.666667 38.4 230.4 98.133333 12.8 12.8 34.133333 12.8 46.933334 0 12.8-12.8 12.8-34.133333 4.266666-46.933333-72.533333-76.8-174.933333-119.466667-281.6-119.466667z m704-183.466666c72.533333-119.466667 85.333333-264.533333 42.666667-396.8-4.266667-12.8-17.066667-21.333333-29.866667-21.333334h-8.533333c-64 0-123.733333 12.8-183.466667 38.4-29.866667-64-76.8-119.466667-132.266666-162.133333l-4.266667-4.266667c-12.8-4.266667-25.6-4.266667-34.133333 0-4.266667 0-4.266667 4.266667-8.533334 4.266667-55.466667 42.666667-102.4 98.133333-132.266666 162.133333-59.733333-25.6-119.466667-38.4-179.2-34.133333h-12.8c-12.8 0-21.333333 8.533333-29.866667 17.066667-46.933333 132.266667-29.866667 277.333333 42.666667 396.8 55.466667 102.4 157.866667 170.666667 273.066666 187.733333h29.866667v166.4c0 17.066667 17.066667 34.133333 34.133333 34.133333s29.866667-12.8 34.133334-34.133333v-166.4h29.866666c110.933333-17.066667 213.333333-85.333333 268.8-187.733333z m34.133334 183.466666c-106.666667 0-209.066667 46.933333-281.6 119.466667-12.8 12.8-12.8 34.133333 0 46.933333 12.8 12.8 34.133333 12.8 46.933333 0 64-59.733333 145.066667-98.133333 230.4-98.133333 17.066667 0 34.133333-17.066667 34.133333-34.133333 4.266667-21.333333-12.8-34.133333-29.866666-34.133334z`,
  shape2: `M857.82 539.49c18.91 1.42 100.42 12.27-14.2-50.8 0 0 55.83-10.46 68.43-39.65 0 0-42.92 16.3-54.11 8.5s34.22-19.83 40.22-24.26-2.41-9.08-33.55-5.32 8.1-12.31 20.71-23.42-10.14-2.7-10.14-2.7 22.81-13.21-10-12.3-53.21 5.12-5.56-24.39-17-17.78-35.66-15.52-81.63 34.92-22.6-37.37c19.88-24.84 10-28.67-18.16-13.27s-59.87 70.86-40-8.24-28.12 46.76-60 44.29c-28.58 21.33-55.44 58.79-59.79 66.07S554.68 460 553.33 456c-0.43-1.25-5.45 3.55-11.87 11.32 24.8-49.45 64.87-127.82 78.94-146.68 3.64-6 11.05-42.8 24.86-49.13s5-16.22-15.54-1.73 27.85-19.44 12.21-53.16c0 0-60.37 76.11-12.14-13.41 7.19-17.55 42.7-91.71-52.71-2.19 0 0 7.32-56.33-16.56-77.33 0 0 2.24 45.86-8.63 54.08s-8.28-38.67-10.64-45.77-9.38-0.52-15.43 30.26-9.2-11.51-15.87-26.93-5.7 8.8-5.7 8.8-5.52-25.77-14.79 5.7-11.57 52.17-24.91-2.23-22.15 10.64-25.78 29.11 8 88.44-42.52 9.95c-17.49-26.58-24.17-18.41-18.24 13.18s48.89 78.83-20.2 35.49 35.78 41.21 23.58 70.78c11.45 33.77 38.77 70.89 44.35 77.28s34.75 83.54 30.54 83.6c-1.32 0 1.71 6.28 7.1 14.79-39.38-38.87-101.51-101.19-115.1-120.4-4.55-5.32-37.3-23.74-39-38.83s-13.9-9.72-6.44 14.24-9.89-32.5-46.79-28c0 0 53.74 80.93-16.5 7.41-14.47-12.27-74-69-18.37 49.44 0 0-51.32-24.36-78.67-8.14 0 0 44.31 12 48.77 24.92s-39.33-4.07-46.79-4-3.39 8.76 24 24-13.79 5.19-30.51 6.78 6.61 8.13 6.61 8.13-26.23-2.71 0.84 15.83 46.06 27.13-9.83 23 3.27 24.35 19.72 33.51 86.57 19.73-3.68 43.52c-30.69 8.41-25 17.29 6.89 21.41s90.09-22.14 27.52 30.18 50.24-21.3 74.6-0.55c35.66-0.45 79.4-15 87.2-18.3s90.19-7.23 88.95-3.22c-0.39 1.26 6.49 0.33 16.25-2.18-49.13 25.43-127.6 65.28-150.07 72.26-6.46 2.69-34.1 28.14-49 25.14s-13.54 10.22 11.56 10.53-34-0.64-41.12 35.84c0 0 93.57-26.1 1.94 18-16.14 10-88.46 49.09 41.35 32.75 0 0-39 41.27-32.06 72.3 0 0 25.14-38.42 38.78-38.68s-16 36.15-18.28 43.26 7.28 5.93 30.26-15.42 0.68 14.72-3 31.12 9.78-3.77 9.78-3.77-10.68 24.1 15.31 4.08 40-35.41 18.84 16.47 24.17 4.41 38-8.4 45.52-76.24 40.25 16.94c-1.47 31.79 8.73 29.1 22.5 0.07s6.78-92.52 37.21-16.85-4.73-54.37 22.52-71.12c10.59-34 10.3-80.14 9.54-88.59s21-88 24.43-85.59c1.08 0.76 2.32-6.07 3-16.13 9 54.58 22.64 141.53 22.34 165.06 0.56 7 16.22 41.13 8.77 54.36s5.53 16 13.58-7.73-11.1 32.1 21.38 50.18c0 0 4.1-97.06 17.7 3.72 4.49 18.42 19.36 99.29 43.93-29.21 0 0 27.19 49.87 58.85 52.83 0 0-28.76-35.79-24.8-48.83s29.42 26.41 35.49 30.75 7.89-5.09-5.31-33.55 14.21 3.9 28.68 12.46-0.57-10.47-0.57-10.47 19.62 17.6 8.62-13.3-21.32-49 21.47-12.83 11.67-21.63 3.75-38.7-58.44-66.85 28.55-33c29.77 11.23 30.37 0.7 7-21.38s-85.89-35-4.52-40.59-53.17-12.3-60.68-43.39c-29.11-20.6-73-34.56-81.3-36.45s-77.22-47.17-73.85-49.69c1.06-0.79-5.07-4.08-14.43-7.79C634 545.4 721 559.29 743.23 566.84c6.8 1.63 44.13-2.71 54.42 8.46s17-0.3-3.16-15.3 27.1 20.47 54.33-4.83c0 0-91.04-33.89 9-15.68z`,
  shape3: `M853.333333 256h-170.666666V170.666667c0-47.146667-38.186667-85.333333-85.333334-85.333334h-170.666666c-47.146667 0-85.333333 38.186667-85.333334 85.333334v85.333333H170.666667c-47.146667 0-84.906667 38.186667-84.906667 85.333333L85.333333 810.666667c0 47.146667 38.186667 85.333333 85.333334 85.333333h682.666666c47.146667 0 85.333333-38.186667 85.333334-85.333333V341.333333c0-47.146667-38.186667-85.333333-85.333334-85.333333z m-256 0h-170.666666V170.666667h170.666666v85.333333z`,
  shape4: `M955.733333 243.2c-4.266667-4.266667-8.533333-8.533333-17.066666-8.533333H187.733333l-29.866666-110.933334c0-8.533333-8.533333-17.066667-21.333334-17.066666H64v42.666666h59.733333L256 686.933333c4.266667 8.533333 12.8 17.066667 21.333333 17.066667h554.666667c8.533333 0 17.066667-8.533333 21.333333-17.066667l106.666667-426.666666c0-4.266667 0-12.8-4.266667-17.066667zM277.333333 746.666667c-46.933333 0-85.333333 38.4-85.333333 85.333333s38.4 85.333333 85.333333 85.333333 85.333333-38.4 85.333334-85.333333-38.4-85.333333-85.333334-85.333333z m0 128c-25.6 0-42.666667-17.066667-42.666666-42.666667s17.066667-42.666667 42.666666-42.666667 42.666667 17.066667 42.666667 42.666667-17.066667 42.666667-42.666667 42.666667zM832 746.666667c-46.933333 0-85.333333 38.4-85.333333 85.333333s38.4 85.333333 85.333333 85.333333 85.333333-38.4 85.333333-85.333333-38.4-85.333333-85.333333-85.333333z m0 128c-25.6 0-42.666667-17.066667-42.666667-42.666667s17.066667-42.666667 42.666667-42.666667 42.666667 17.066667 42.666667 42.666667-17.066667 42.666667-42.666667 42.666667z`,
}

onMounted(() => {
  initTHREE()
  initShapeBySvg(path.shape0)
  initMesh()
  initLight()
  initGUI()
  render()
})

const geoOptions = {
  curveSegments: 12,
  steps: 1,
  depth: 100,
  bevelEnabled: true,
  bevelThickness: 6,
  bevelSize: 6,
  bevelOffset: 0,
  bevelSegments: 3,
}
const controls = {
  selectShap: 'shape0',
}
function initGUI() {
  let gui = new GUI({
    autoPlace: false,
    width: 300,
  })
  gui.domElement.style.cssText = 'position: fixed; top: 0; right: 0;'
  canvasCon.value?.appendChild(gui.domElement)
  gui
    .add(controls, 'selectShap', [
      'shape0',
      'shape1',
      'shape2',
      'shape3',
      'shape4',
    ])
    .onChange((val) => {
      initShapeBySvg(path[val])
      initMesh()
    })
  gui.add(geoOptions, 'curveSegments', 1, 24, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'steps', 1, 10, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'depth', 1, 200, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'bevelEnabled').onChange(() => initMesh())
  gui.add(geoOptions, 'bevelThickness', 1, 12, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'bevelSize', 1, 12, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'bevelOffset', 1, 24, 1).onChange(() => initMesh())
  gui.add(geoOptions, 'bevelSegments', 1, 24, 1).onChange(() => initMesh())
}

let step = 0
function animate() {
  mesh.rotation.y = step += 0.005
}
function initShapeBySvg(svgPath: string) {
  shapes = transformSVGPathExposed(svgPath)
}
function initMesh() {
  let geo = new THREE.ExtrudeGeometry(shapes, geoOptions)
  geo.applyMatrix4(new THREE.Matrix4().makeTranslation(-430, -300, 0))
  geo.applyMatrix4(new THREE.Matrix4().makeRotationZ(PI))

  if (mesh) scene.remove(mesh)
  const mat = new THREE.MeshPhongMaterial({ color: 0x333333, shininess: 100 })
  mesh = new THREE.Mesh(geo, mat)
  mesh.scale.multiplyScalar(0.05)
  scene.add(mesh)
}
function initLight() {
  const spotLight = new THREE.DirectionalLight(0x0984e3)
  spotLight.position.set(-30, 30, -30)
  spotLight.intensity = 0.7
  spotLight.target = mesh
  const spotLightHelper = new THREE.DirectionalLightHelper(spotLight, 10)
  scene.add(spotLightHelper)
  scene.add(spotLight)
}
// three初始化
function initTHREE() {
  scene = new THREE.Scene()
  scene.background = new THREE.Color(0xffffff)
  camera = new THREE.PerspectiveCamera(75, width / height, 1, 1000)
  renderer = new THREE.WebGLRenderer({
    canvas: canvasDom.value,
    antialias: true,
  })
  // renderer.shadowMap.enabled = true
  renderer.setSize(width, height)
  // renderer.setPixelRatio(window.devicePixelRatio) // 不推荐
  window.addEventListener('resize', onWindowResize)

  // 坐标轴
  scene.add(new THREE.AxesHelper(1000))

  // 帧率状态
  stats = Stats()
  canvasCon.value!.append(stats.dom)

  // 轨道控制器
  orbitControls = new OrbitControls(camera, renderer.domElement)
  orbitControls.target = new THREE.Vector3(0, 0, 0)
  orbitControls.object.position.set(0, 30, 50)
  orbitControls.update()
}
// 绘制
function render() {
  requestAnimationFrame(render)
  stats.update()
  animate()
  renderer.render(scene, camera)
}
// 自适应
function onWindowResize() {
  width = window.innerWidth
  height = window.innerHeight
  camera.aspect = width / height
  camera.updateProjectionMatrix()
  renderer.setSize(width, height)
}
</script>
